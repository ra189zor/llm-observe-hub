<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM-Lens Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Enhanced UI/UX Styles */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: #2c3e50 !important;
        }

        .navbar-text {
            color: #7f8c8d !important;
        }

        .container-fluid {
            padding: 30px;
        }

        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .card-header {
            border: none;
            background: transparent;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }

        .card-body {
            padding: 1.5rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-outline-primary {
            border-color: #667eea;
            color: #667eea;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover {
            background: #667eea;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .table {
            border-radius: 10px;
            overflow: hidden;
        }

        .table th {
            background: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #2c3e50;
        }

        .table td {
            border: none;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            vertical-align: middle;
        }

        .alert {
            border: none;
            border-radius: 15px;
            padding: 20px;
        }

        .progress {
            height: 8px;
            border-radius: 10px;
            background: rgba(0,0,0,0.1);
        }

        .progress-bar {
            border-radius: 10px;
        }

        .badge {
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 500;
        }

        .optimization-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .optimization-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
        }

        .optimization-card.priority-medium {
            background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
        }

        .optimization-card.priority-low {
            background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            padding: 12px 15px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .back-to-home {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            font-size: 0.9rem;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .back-to-home:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            color: white;
        }

        /* Loading Indicators */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: relative;
        }

        .loading-spinner::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #764ba2;
            border-radius: 50%;
            animation: spin 1.5s linear infinite reverse;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 1.2rem;
            font-weight: 500;
            margin-top: 20px;
            text-align: center;
        }

        .loading-dots {
            display: inline-block;
            margin-left: 5px;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* Table row loading state */
        .table-row-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading-shimmer 1.5s infinite;
        }

        @keyframes loading-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Button loading state */
        .btn-loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Card loading state */
        .card-loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .card-loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 25%, rgba(255,255,255,0.5) 50%, transparent 75%);
            background-size: 200% 100%;
            animation: loading-shimmer 1.5s infinite;
            z-index: 1;
            border-radius: inherit;
        }

        /* Progress bar loading */
        .progress-loading {
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: progress-slide 2s infinite;
        }

        @keyframes progress-slide {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Toast notification for loading states */
        .toast-loading {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            min-width: 300px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 15px;
            display: flex;
            align-items: center;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast-loading.show {
            transform: translateX(0);
        }

        .toast-loading .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #e3e3e3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 15px;
            }

            .back-to-home {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
            }

            .loading-spinner {
                width: 60px;
                height: 60px;
            }

            .toast-loading {
                min-width: 250px;
                top: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <a href="/" class="back-to-home">
        <i class="fas fa-home"></i>
        Back to Home
    </a>

    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-eye me-2"></i>LLM-Lens Dashboard
            </span>
            <span class="navbar-text">
                Real-time LLM Observability
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Enhanced Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title">{{ recent_logs|length }}</h4>
                                <p class="card-text">Total Requests</p>
                            </div>
                            <div>
                                <i class="fas fa-chart-line fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="success-count">0</h4>
                                <p class="card-text">Successful</p>
                            </div>
                            <div>
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-white bg-danger">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="error-count">0</h4>
                                <p class="card-text">Errors</p>
                            </div>
                            <div>
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="avg-latency">0ms</h4>
                                <p class="card-text">Avg Latency</p>
                            </div>
                            <div>
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="streaming-count">0</h4>
                                <p class="card-text">Streaming</p>
                            </div>
                            <div>
                                <i class="fas fa-stream fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-white bg-secondary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="performance-score">0</h4>
                                <p class="card-text">Avg Score</p>
                            </div>
                            <div>
                                <i class="fas fa-tachometer-alt fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        {% if alert_events %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-bell me-2"></i>Recent Alerts
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for alert in alert_events[:3] %}
                            <div class="col-md-4 mb-2">
                                <div class="alert alert-warning alert-dismissible fade show mb-0" role="alert">
                                    <strong>{{ alert.rule_name }}</strong><br>
                                    <small>{{ alert.message }}</small><br>
                                    <small class="text-muted">{{ alert.triggered_at }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% if alert_events|length > 3 %}
                        <div class="text-center mt-2">
                            <button class="btn btn-outline-warning btn-sm" onclick="showAllAlerts()">
                                View All {{ alert_events|length }} Alerts
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Enhanced Charts Row -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>Latency Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="latencyChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Token Usage by Model
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="tokenChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-tachometer-alt me-2"></i>Performance Score
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="performanceChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Streaming Analytics Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-stream me-2"></i>Streaming vs Non-Streaming
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="streamingChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-download me-2"></i>Export Data
                        </h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportData('csv')">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportData('json')">
                                <i class="fas fa-file-code me-1"></i>JSON
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="exportHours" class="form-label">Time Range (hours)</label>
                                <select class="form-select" id="exportHours">
                                    <option value="1">Last 1 hour</option>
                                    <option value="6">Last 6 hours</option>
                                    <option value="24" selected>Last 24 hours</option>
                                    <option value="168">Last week</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="exportModel" class="form-label">Model Filter</label>
                                <select class="form-select" id="exportModel">
                                    <option value="">All Models</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary w-100" onclick="getAnalytics()">
                                <i class="fas fa-chart-pie me-1"></i>View Advanced Analytics
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Comparison Dashboard -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-balance-scale me-2"></i>Model Performance Comparison
                        </h5>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshModelComparison()">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <canvas id="modelPerformanceChart"></canvas>
                            </div>
                            <div class="col-md-6">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Model</th>
                                                <th>Avg Latency</th>
                                                <th>Throughput</th>
                                                <th>Performance</th>
                                                <th>Requests</th>
                                            </tr>
                                        </thead>
                                        <tbody id="modelComparisonTable">
                                            <!-- Model comparison data will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="modelRecommendation" class="alert alert-info mt-3" style="display: none;">
                                    <strong>Recommendation:</strong> <span id="recommendedModel"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cost Tracking Dashboard -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-dollar-sign me-2"></i>Cost Analysis
                        </h5>
                        <div>
                            <select id="costTimePeriod" class="form-select form-select-sm d-inline" style="width: auto;">
                                <option value="24">Last 24 hours</option>
                                <option value="168">Last 7 days</option>
                                <option value="720">Last 30 days</option>
                            </select>
                            <button class="btn btn-outline-primary btn-sm ms-2" onclick="refreshCostAnalysis()">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="costChart"></canvas>
                        <div class="mt-3">
                            <h6>Total Cost: <span id="totalCostDisplay" class="text-primary">$0.00</span></h6>
                            <div id="costBreakdown" class="mt-2">
                                <!-- Cost breakdown will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-piggy-bank me-2"></i>Budget Tracking
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="budgetsList">
                            <!-- Budget items will be populated here -->
                        </div>
                        <button class="btn btn-outline-success btn-sm mt-2" onclick="showBudgetModal()">
                            <i class="fas fa-plus"></i> Add Budget
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Optimization Suggestions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-lightbulb me-2"></i>Performance Optimization Suggestions
                        </h5>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="generateOptimizationSuggestions()">
                                <i class="fas fa-magic me-1"></i>Generate Suggestions
                            </button>
                            <button class="btn btn-outline-primary btn-sm ms-2" onclick="refreshOptimizationSuggestions()">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="optimizationSuggestions">
                            <!-- Optimization suggestions will be populated here -->
                        </div>
                        <div id="noOptimizationSuggestions" class="text-center py-4" style="display: none;">
                            <i class="fas fa-robot fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No optimization suggestions available</h5>
                            <p class="text-muted">Click "Generate Suggestions" to get AI-powered recommendations based on your model performance.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-table me-2"></i>Recent Requests
                        </h5>
                        <div class="d-flex gap-2">
                            <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Search requests..." style="width: 300px;">
                            <select id="statusFilter" class="form-select form-select-sm" style="width: 120px;">
                                <option value="">All Status</option>
                                <option value="Success">Success</option>
                                <option value="Error">Error</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="logsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Time</th>
                                        <th>Model</th>
                                        <th>Latency</th>
                                        <th>Tokens</th>
                                        <th>Status</th>
                                        <th>Input Preview</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in recent_logs %}
                                    <tr>
                                        <td>{{ log.start_time }}</td>
                                        <td>
                                            <span class="badge bg-secondary">{{ log.model_name }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ log.latency_ms }}ms</span>
                                        </td>
                                        <td>{{ log.total_tokens }}</td>
                                        <td>
                                            {% if log.status == "Success" %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>Success
                                                </span>
                                            {% else %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-times me-1"></i>Error
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td class="text-truncate" style="max-width: 200px;">
                                            {{ log.input_text }}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    onclick="showLogDetails({{ log.id }})"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#logModal">
                                                <i class="fas fa-eye me-1"></i>View
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if not recent_logs %}
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No requests logged yet</h5>
                            <p class="text-muted">Send requests through the proxy endpoint to see data here.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Details Modal -->
    <div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logModalLabel">
                        <i class="fas fa-info-circle me-2"></i>Request Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-info me-2"></i>Metadata</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Model:</strong></td><td id="modal-model"></td></tr>
                                <tr><td><strong>Start Time:</strong></td><td id="modal-start-time"></td></tr>
                                <tr><td><strong>End Time:</strong></td><td id="modal-end-time"></td></tr>
                                <tr><td><strong>Latency:</strong></td><td id="modal-latency"></td></tr>
                                <tr><td><strong>Prompt Tokens:</strong></td><td id="modal-prompt-tokens"></td></tr>
                                <tr><td><strong>Completion Tokens:</strong></td><td id="modal-completion-tokens"></td></tr>
                                <tr><td><strong>Total Tokens:</strong></td><td id="modal-total-tokens"></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6" id="error-section" style="display: none;">
                            <h6><i class="fas fa-exclamation-triangle me-2 text-danger"></i>Error Details</h6>
                            <div class="alert alert-danger">
                                <pre id="modal-error" class="mb-0"></pre>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6><i class="fas fa-arrow-right me-2 text-primary"></i>Input Text</h6>
                            <div class="border rounded p-3" style="height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                                <pre id="modal-input" class="mb-0"></pre>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-arrow-left me-2 text-success"></i>Output Text</h6>
                            <div class="border rounded p-3" style="height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                                <pre id="modal-output" class="mb-0"></pre>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading<span class="loading-dots"></span></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize enhanced charts data from template
        const latencyData = {{ latency_data | tojson }};
        const tokenUsage = {{ token_usage | tojson }};
        const performanceData = {{ performance_data | tojson }};
        const streamingData = {{ streaming_data | tojson }};
        const logsData = {{ recent_logs | tojson }};

        // Function to show loading overlay
        function showLoading() {
            document.querySelector('.loading-overlay').classList.add('show');
        }

        // Function to hide loading overlay
        function hideLoading() {
            document.querySelector('.loading-overlay').classList.remove('show');
        }

        // Initialize enhanced charts
        function initializeCharts() {
            // Enhanced Latency Chart with P95
            const latencyCtx = document.getElementById('latencyChart').getContext('2d');
            new Chart(latencyCtx, {
                type: 'line',
                data: {
                    labels: latencyData.map(d => d.hour),
                    datasets: [{
                        label: 'Average Latency (ms)',
                        data: latencyData.map(d => d.avg_latency),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: false
                    }, {
                        label: 'P95 Latency (ms)',
                        data: latencyData.map(d => d.p95_latency),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Latency (ms)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (24h)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });

            // Enhanced Token Usage Chart with Throughput
            const tokenCtx = document.getElementById('tokenChart').getContext('2d');
            new Chart(tokenCtx, {
                type: 'bar',
                data: {
                    labels: tokenUsage.map(d => d.model),
                    datasets: [{
                        label: 'Total Tokens',
                        data: tokenUsage.map(d => d.tokens),
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: 'Avg Throughput (tokens/s)',
                        data: tokenUsage.map(d => d.avg_throughput),
                        backgroundColor: 'rgba(255, 99, 132, 0.8)',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Total Tokens'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'Throughput (tokens/s)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });

            // Performance Score Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: performanceData.map(d => d.hour),
                    datasets: [{
                        label: 'Performance Score',
                        data: performanceData.map(d => d.avg_score),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: 'Score (0-1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (24h)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });

            // Streaming vs Non-Streaming Chart
            const streamingCtx = document.getElementById('streamingChart').getContext('2d');
            new Chart(streamingCtx, {
                type: 'bar',
                data: {
                    labels: streamingData.map(d => d.hour),
                    datasets: [{
                        label: 'Streaming Requests',
                        data: streamingData.map(d => d.streaming_requests),
                        backgroundColor: 'rgba(255, 206, 86, 0.8)',
                        borderWidth: 1
                    }, {
                        label: 'Non-Streaming Requests',
                        data: streamingData.map(d => d.total_requests - d.streaming_requests),
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Request Count'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        // Calculate and update enhanced summary cards
        function updateSummaryCards() {
            showLoading();
            const successCount = logsData.filter(log => log.status === 'Success').length;
            const errorCount = logsData.filter(log => log.status === 'Error').length;
            const streamingCount = logsData.filter(log => log.is_streaming).length;

            const totalLatency = logsData.reduce((sum, log) => sum + log.latency_ms, 0);
            const avgLatency = logsData.length > 0 ? Math.round(totalLatency / logsData.length) : 0;

            const totalPerformance = logsData.reduce((sum, log) => sum + (log.performance_score || 0), 0);
            const avgPerformance = logsData.length > 0 ? (totalPerformance / logsData.length).toFixed(2) : 0;

            document.getElementById('success-count').textContent = successCount;
            document.getElementById('error-count').textContent = errorCount;
            document.getElementById('avg-latency').textContent = avgLatency + 'ms';
            document.getElementById('streaming-count').textContent = streamingCount;
            document.getElementById('performance-score').textContent = avgPerformance;

            // Populate export model filter
            const models = [...new Set(logsData.map(log => log.model_name))];
            const modelSelect = document.getElementById('exportModel');
            modelSelect.innerHTML = '<option value="">All Models</option>';
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
            hideLoading();
        }

        // Enhanced log details modal with new metrics
        async function showLogDetails(logId) {
            showLoading();
            try {
                const response = await fetch(`/api/logs/${logId}`);
                if (!response.ok) throw new Error('Failed to fetch log details');

                const log = await response.json();

                // Update enhanced modal content with new metrics
                document.getElementById('modal-model').textContent = log.model_name;
                document.getElementById('modal-start-time').textContent = new Date(log.start_time).toLocaleString();
                document.getElementById('modal-end-time').textContent = new Date(log.end_time).toLocaleString();
                document.getElementById('modal-latency').textContent = log.latency_ms + 'ms';
                document.getElementById('modal-prompt-tokens').textContent = log.prompt_tokens || 'N/A';
                document.getElementById('modal-completion-tokens').textContent = log.completion_tokens || 'N/A';
                document.getElementById('modal-total-tokens').textContent = log.total_tokens || 'N/A';
                document.getElementById('modal-input').textContent = log.input_text;
                document.getElementById('modal-output').textContent = log.output_text;

                // Add additional metadata rows for enhanced metrics
                const metadataTable = document.querySelector('#logModal table');
                if (metadataTable && log.tokens_per_second) {
                    const existingEnhanced = metadataTable.querySelector('.enhanced-metrics');
                    if (existingEnhanced) existingEnhanced.remove();

                    const enhancedSection = document.createElement('tbody');
                    enhancedSection.className = 'enhanced-metrics';
                    enhancedSection.innerHTML = `
                        <tr><td><strong>Streaming:</strong></td><td>${log.is_streaming ? 'Yes' : 'No'}</td></tr>
                        <tr><td><strong>Throughput:</strong></td><td>${log.tokens_per_second?.toFixed(2) || 'N/A'} tokens/s</td></tr>
                        <tr><td><strong>TTFT:</strong></td><td>${log.time_to_first_token_ms || 'N/A'}ms</td></tr>
                        <tr><td><strong>Performance:</strong></td><td>${log.performance_score?.toFixed(3) || 'N/A'}</td></tr>
                        <tr><td><strong>Temperature:</strong></td><td>${log.temperature || 'N/A'}</td></tr>
                        <tr><td><strong>Max Tokens:</strong></td><td>${log.max_tokens || 'N/A'}</td></tr>
                    `;
                    metadataTable.appendChild(enhancedSection);
                }

                // Show/hide error section
                const errorSection = document.getElementById('error-section');
                if (log.error_message) {
                    document.getElementById('modal-error').textContent = log.error_message;
                    errorSection.style.display = 'block';
                } else {
                    errorSection.style.display = 'none';
                }

            } catch (error) {
                console.error('Error fetching log details:', error);
                alert('Failed to load log details');
            } finally {
                hideLoading();
            }
        }

        // Export data functionality
        async function exportData(format) {
            showLoading();
            const hours = document.getElementById('exportHours').value;
            const model = document.getElementById('exportModel').value;

            try {
                const params = new URLSearchParams({ hours });
                if (model) params.append('model', model);

                const response = await fetch(`/api/export/${format}?${params}`);
                if (!response.ok) throw new Error('Export failed');

                // Create download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `llm_lens_export_${new Date().toISOString().slice(0,10)}.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                console.error('Export error:', error);
                alert('Export failed. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // Get advanced analytics
        async function getAnalytics() {
            showLoading();
            try {
                const response = await fetch('/api/analytics');
                if (!response.ok) throw new Error('Failed to fetch analytics');

                const analytics = await response.json();

                // Show analytics in modal or new window
                const analyticsWindow = window.open('', '_blank', 'width=800,height=600');
                analyticsWindow.document.write(`
                    <html>
                    <head>
                        <title>LLM-Lens Advanced Analytics</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                    </head>
                    <body class="container mt-4">
                        <h2>Advanced Performance Analytics</h2>
                        <div class="row">
                            <div class="col-md-6">
                                <h4>Performance Insights</h4>
                                <pre>${JSON.stringify(analytics.performance_insights, null, 2)}</pre>
                            </div>
                            <div class="col-md-6">
                                <h4>Model Comparison</h4>
                                <pre>${JSON.stringify(analytics.model_comparison, null, 2)}</pre>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4>Trend Analysis</h4>
                                <pre>${JSON.stringify(analytics.trend_analysis, null, 2)}</pre>
                            </div>
                        </div>
                    </body>
                    </html>
                `);

            } catch (error) {
                console.error('Analytics error:', error);
                alert('Failed to load analytics. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // Show all alerts
        function showAllAlerts() {
            // Implementation for showing all alerts in a modal
            alert('View all alerts functionality - would show detailed alert management interface');
        }

        // Model Comparison Functions
        async function refreshModelComparison() {
            showLoading();
            try {
                const response = await fetch('/api/model-performance?hours=24');
                const data = await response.json();

                // Update model comparison table
                const tableBody = document.getElementById('modelComparisonTable');
                tableBody.innerHTML = '';

                data.models.forEach(model => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${model.model_name}</strong></td>
                        <td>${model.avg_latency}ms</td>
                        <td>${model.avg_throughput} t/s</td>
                        <td>${model.avg_performance}</td>
                        <td>${model.request_count}</td>
                    `;
                    tableBody.appendChild(row);
                });

                // Show recommendation
                if (data.recommendation) {
                    const recommendationDiv = document.getElementById('modelRecommendation');
                    document.getElementById('recommendedModel').textContent = data.recommendation;
                    recommendationDiv.style.display = 'block';
                }

                // Update model performance chart
                updateModelPerformanceChart(data.models);

            } catch (error) {
                console.error('Error refreshing model comparison:', error);
                alert('Failed to refresh model comparison');
            } finally {
                hideLoading();
            }
        }

        function updateModelPerformanceChart(models) {
            const ctx = document.getElementById('modelPerformanceChart').getContext('2d');

            if (window.modelPerformanceChart) {
                window.modelPerformanceChart.destroy();
            }

            window.modelPerformanceChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Latency', 'Throughput', 'Performance', 'Reliability'],
                    datasets: models.map((model, index) => ({
                        label: model.model_name,
                        data: [
                            100 - (model.avg_latency / 50), // Invert latency (lower is better)
                            model.avg_throughput,
                            model.avg_performance * 100,
                            (model.request_count / Math.max(...models.map(m => m.request_count))) * 100
                        ],
                        borderColor: `hsl(${index * 137.5}, 70%, 50%)`,
                        backgroundColor: `hsla(${index * 137.5}, 70%, 50%, 0.2)`,
                        pointBackgroundColor: `hsl(${index * 137.5}, 70%, 50%)`,
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: `hsl(${index * 137.5}, 70%, 50%)`
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Cost Tracking Functions
        async function refreshCostAnalysis() {
            showLoading();
            const hours = document.getElementById('costTimePeriod').value;

            try {
                const response = await fetch(`/api/cost-analysis?hours=${hours}`);
                const data = await response.json();

                // Update total cost display
                document.getElementById('totalCostDisplay').textContent = `$${data.total_cost}`;

                // Update cost breakdown
                const breakdownDiv = document.getElementById('costBreakdown');
                breakdownDiv.innerHTML = '';

                Object.entries(data.cost_breakdown).forEach(([model, stats]) => {
                    const item = document.createElement('div');
                    item.className = 'mb-2';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <span><strong>${model}</strong></span>
                            <span class="text-success">$${stats.estimated_cost.toFixed(4)}</span>
                        </div>
                        <div class="text-muted small">
                            ${stats.requests} requests, ${stats.total_tokens} tokens, ${stats.avg_latency.toFixed(0)}ms avg
                        </div>
                    `;
                    breakdownDiv.appendChild(item);
                });

                // Update cost chart
                updateCostChart(data.cost_breakdown);

            } catch (error) {
                console.error('Error refreshing cost analysis:', error);
                alert('Failed to refresh cost analysis');
            } finally {
                hideLoading();
            }
        }

        function updateCostChart(costBreakdown) {
            const ctx = document.getElementById('costChart').getContext('2d');

            if (window.costChart) {
                window.costChart.destroy();
            }

            const models = Object.keys(costBreakdown);
            const costs = Object.values(costBreakdown).map(stats => stats.estimated_cost);

            window.costChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: models,
                    datasets: [{
                        data: costs,
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        async function loadBudgets() {
            showLoading();
            try {
                const response = await fetch('/api/budgets');
                const budgets = await response.json();

                const budgetsList = document.getElementById('budgetsList');
                budgetsList.innerHTML = '';

                budgets.forEach(budget => {
                    const budgetItem = document.createElement('div');
                    budgetItem.className = 'card mb-2';

                    const usagePercent = (budget.current_usage / budget.amount) * 100;
                    const progressClass = usagePercent > 90 ? 'bg-danger' : usagePercent > 70 ? 'bg-warning' : 'bg-success';

                    budgetItem.innerHTML = `
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="fw-bold">${budget.name}</small>
                                <span class="badge ${budget.is_active ? 'bg-success' : 'bg-secondary'}">
                                    ${budget.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                            <div class="progress mb-1" style="height: 8px;">
                                <div class="progress-bar ${progressClass}" style="width: ${Math.min(usagePercent, 100)}%"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">$${budget.current_usage.toFixed(2)} / $${budget.amount}</small>
                                <small class="text-muted">${budget.budget_type}</small>
                            </div>
                        </div>
                    `;
                    budgetsList.appendChild(budgetItem);
                });

            } catch (error) {
                console.error('Error loading budgets:', error);
            } finally {
                hideLoading();
            }
        }

        function showBudgetModal() {
            const name = prompt('Budget name:');
            const amount = parseFloat(prompt('Budget amount ($):'));
            const type = prompt('Budget type (daily/weekly/monthly):');

            if (name && amount && type) {
                createBudget(name, amount, type);
            }
        }

        async function createBudget(name, amount, type) {
            showLoading();
            try {
                const response = await fetch('/api/budgets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `name=${encodeURIComponent(name)}&amount=${amount}&budget_type=${encodeURIComponent(type)}`
                });

                if (response.ok) {
                    loadBudgets();
                } else {
                    alert('Failed to create budget');
                }
            } catch (error) {
                console.error('Error creating budget:', error);
                alert('Failed to create budget');
            } finally {
                hideLoading();
            }
        }

        // Performance Optimization Suggestions Functions
        async function generateOptimizationSuggestions() {
            showLoading();
            try {
                const response = await fetch('/api/optimization-suggestions/generate', {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`Generated ${result.suggestions.length} optimization suggestions`);
                    refreshOptimizationSuggestions();
                } else {
                    alert('Failed to generate optimization suggestions');
                }
            } catch (error) {
                console.error('Error generating optimization suggestions:', error);
                alert('Failed to generate optimization suggestions');
            } finally {
                hideLoading();
            }
        }

        async function refreshOptimizationSuggestions() {
            showLoading();
            try {
                const response = await fetch('/api/optimization-suggestions');
                const suggestions = await response.json();

                const suggestionsDiv = document.getElementById('optimizationSuggestions');
                const noSuggestionsDiv = document.getElementById('noOptimizationSuggestions');

                if (suggestions.length === 0) {
                    suggestionsDiv.style.display = 'none';
                    noSuggestionsDiv.style.display = 'block';
                    return;
                }

                suggestionsDiv.style.display = 'block';
                noSuggestionsDiv.style.display = 'none';
                suggestionsDiv.innerHTML = '';

                suggestions.forEach(suggestion => {
                    const suggestionCard = document.createElement('div');
                    suggestionCard.className = `optimization-card priority-${suggestion.priority}`;

                    const typeIcon = suggestion.suggestion_type === 'performance' ? 'fas fa-tachometer-alt' :
                                   suggestion.suggestion_type === 'parameter' ? 'fas fa-sliders-h' :
                                   'fas fa-microchip';

                    suggestionCard.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="${typeIcon} me-2"></i>
                                    <h6 class="mb-0">${suggestion.title}</h6>
                                    <span class="badge bg-light text-dark ms-2">${suggestion.priority.toUpperCase()}</span>
                                </div>
                                <p class="mb-2">${suggestion.description}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small>
                                        <i class="fas fa-bullseye me-1"></i>
                                        Expected: ${suggestion.potential_improvement || 'N/A'}
                                    </small>
                                    <small>
                                        <i class="fas fa-tag me-1"></i>
                                        Model: ${suggestion.model_name}
                                    </small>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-light ms-3" onclick="implementSuggestion(${suggestion.id})">
                                <i class="fas fa-check me-1"></i>
                                Mark Done
                            </button>
                        </div>
                    `;

                    suggestionsDiv.appendChild(suggestionCard);
                });

            } catch (error) {
                console.error('Error refreshing optimization suggestions:', error);
            } finally {
                hideLoading();
            }
        }

        async function implementSuggestion(suggestionId) {
            showLoading();
            try {
                const response = await fetch(`/api/optimization-suggestions/${suggestionId}/implement`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('Suggestion marked as implemented');
                    refreshOptimizationSuggestions();
                } else {
                    alert('Failed to mark suggestion as implemented');
                }
            } catch (error) {
                console.error('Error implementing suggestion:', error);
                alert('Failed to mark suggestion as implemented');
            } finally {
                hideLoading();
            }
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            updateSummaryCards();
            refreshModelComparison();
            refreshCostAnalysis();
            loadBudgets();
            refreshOptimizationSuggestions();
        });
    </script>
</body>
</html>